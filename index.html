<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>The Bits Between the Bits</title>

    <link rel="stylesheet" href="reveal.js/css/reveal.css">
    <link rel="stylesheet" href="reveal.js/css/theme/black.css">

    <style>
        .reveal .slides section .fragment.highlight-current-code {
            opacity: 1;
            visibility: inherit;
        }

        .reveal .slides section .fragment.highlight-current-code.current-fragment {
            background: #555a5f;
            color: #ffffff;
        }

        }

        .no-border {
            background: none !important;
            border: none !important;
            box-shadow: none !important;

        div.quote {
            max-width: 70%;
            margin: auto;
        }
    </style>
    <!-- Theme used for syntax highlighting of code -->
    <link rel="stylesheet" href="reveal.js/lib/css/zenburn.css">

    <!-- Printing and PDF exports -->
    <script>
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.type = 'text/css';
        link.href = window.location.search.match(/print-pdf/gi) ? 'reveal.js/css/print/pdf.css' : 'reveal.js/css/print/paper.css';
        document.getElementsByTagName('head')[0].appendChild(link);
    </script>
</head>
<body>
<div class="reveal">
    <div class="slides">
        <section>
            <h3>The Bits Between the Bits</h3>
            <h4>How we get to <code>main()</code></h4>
            <h6>Matt Godbolt<br><a href="https://twitter.com/mattgodbolt">@mattgodbolt</a></h6>
            <h6>CppCon 2018</h6>
        </section>
        <section>
            <!-- GCC 8.1 -->
            <section>
                <h3>A program</h3>
                <pre><code class="cpp" data-trim>
                int main() {}
                </code></pre>
                <pre><code class="bash fragment" data-trim data-noescape>
                    $ gcc -Os empty.c -o c/empty
                    $ g++ -Os empty.cpp -o cpp/empty
                    <div class="fragment">
                    $ ls -l cpp/empty c/empty
                    </div><div class="fragment">7976 c/empty
                    </div><div class="fragment">7976 cpp/empty</div>
                </code></pre>
            </section>
            <section>
                <h3>What's in it?</h3>
                <pre><code class="fragment bash" data-trim data-noescape>
                    $ objdump --no-show-raw-insn -dC cpp/empty</code></pre>
                <pre><code class="fragment asm" data-snippet="empty-objdump"></code></pre>
            </section>
            <section>
                <h3>What's in it?</h3>
                <pre><code class="bash fragment" data-trim data-noescape>
$ readelf -a cpp/empty<div class="fragment">
ELF Header:
  Magic:   7f 45 4c 46 02 01 01 00 00 00 00 00 00 00 00 00
  Class:                             ELF64
...
Section Headers:
  [Nr] Name              Type             Address           Offset
  [ 0]                   NULL             0000000000000000  00000000
  [ 1] .interp           PROGBITS         0000000000400238  00000238
...
Relocation section '.rela.dyn' at offset 0x380 contains 2 entries:
  Offset Type              Sym. Value   Sym. Name + Addend
0600ff0  R_X86_64_GLOB_DAT 00000000     __libc_start_main@GLIBC_2.2.5 + 0
0600ff8  R_X86_64_GLOB_DAT 00000000     __gmon_start__ + 0
...
Symbol table '.symtab' contains 58 entries:
   Num:    Value          Size Type    Bind   Vis      Ndx Name
...
    24: 0000000000000000     0 FILE    LOCAL  DEFAULT  ABS empty.cpp
    25: 0000000000000000     0 FILE    LOCAL  DEFAULT  ABS crtstuff.c
...
                    </div>
                </code></pre>
            </section>
        </section>
        <section>
            Edit code / MAKE / run!
            But what witchcraft happens between compiler and that?
            Knowing why will help you understand... ODR violations, link times etc
        </section>
        <section>
            Overview
            linux only
        </section>
        <section>
            Example C program, static and non-static (MAYBE ONLY NON-STATIC?)
            <ul>
                <li>Why is it so large?</li>
                <li>What's in it?</li>
            </ul>
        </section>
        <section>
            <p>C world!
                .o files, tools to look at them
                [maybe turn off debug symbols for this bit?]</p>
            <ul>
                <li>nm (show T main and U puts)</li>
                <li>objdump -d (show disassembly with call 0x00000)</li>
                <li>Show that even symbols in the same file aren't resolved (tricky)</li>
                <li>objdump -r (show reloc)</li>
                <li>objdump -dr (show together)</li>
                <li>readelf? (needed later but for now maybe no?)</li>
            </ul>
            <p>
                sections, relocations (TODO uses for it, hot/cold code and other magic)
                WEAK references (setup for ODR stuff?) - maybe introduce later with C++
            </p>
        </section>
        <section>
            Quick mention of .a files?
        </section>
        <section>
            The linker! (ld, gold)
            High level view of what it does
            * gather sections together, resolve relocations (CHECK is it relocations?)
        </section>
        <section>
            Finding libraries used (-v)
            - dissect command line, look at -dumpspecs (doesn't have everything we'd need to look at)
            start group, end group (library ordering matters)
        </section>
        <section>
            So far C, what about C++?
            simple template usage, show weak refs? (setup for ODR viol?)
        </section>
        <section>
            global constructors, destructors
            - callgrind to main? wth is going on? poll on how many instructions for an empty executable
        </section>
        <section>
            But what about dynamic linkage?
            ld.so, interpreter
            ELF file layout slide?
        </section>
        <section>
            A new challenger enters: LTO!
            - betterer, ODR violation finder
        </section>
        <section>
            Practical advice
            - `LD_DEBUG` and `LD_PRELOAD`
            - LTO usage?
            -
        </section>
        <section>
            - linker sections (-ffunction-sections, -fdata-sections, --gc-sections?)
            -
        </section>
        <section>
            <section>Bonus slides</section>
            <section>
                War stories
                - exceptions thrown across SO bounadaries
                - (global construction order issues?)
            </section>
            <section>
                Advanced section-fu (putting sideband data in a section?)
            </section>
            <section>
                Linker sctipts?
            </section>
        </section>
    </div>
</div>

<script src="reveal.js/lib/js/head.min.js"></script>
<script src="reveal.js/js/reveal.js"></script>


<script>
    Reveal.initialize({
        history: true,
        transition: 'fade',
        slideNumber: true,
        width: 1280,
        height: 720,
        dependencies: [
            {src: 'reveal.js/plugin/markdown/marked.js'},
            {src: 'reveal.js/plugin/markdown/markdown.js'},
            {src: 'reveal.js/plugin/notes/notes.js', async: true},
            {src: 'snippets.js'},
            {
                src: 'reveal.js/plugin/highlight/highlight.js',
                async: true,
                callback: () => hljs.initHighlightingOnLoad()
            }
        ]
    });
</script>
</body>
</html>
