<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>The Bits Between the Bits</title>

    <link rel="stylesheet" href="reveal.js/css/reveal.css">
    <link rel="stylesheet" href="reveal.js/css/theme/black.css">

    <style>
        .reveal .slides section .fragment.highlight-current-code {
            opacity: 1;
            visibility: inherit;
        }

        .reveal .slides section .fragment.highlight-current-code.current-fragment {
            background: #555a5f;
            color: #ffffff;
        }

        .no-border {
            background: none !important;
            border: none !important;
            box-shadow: none !important;
        }

        div.quote {
            max-width: 70%;
            margin: auto;
        }

        div.attribution {
            font-style: italic;
            font-size: x-small;
        }
    </style>
    <!-- Theme used for syntax highlighting of code -->
    <link rel="stylesheet" href="reveal.js/lib/css/zenburn.css">

    <!-- Printing and PDF exports -->
    <script>
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.type = 'text/css';
        link.href = window.location.search.match(/print-pdf/gi) ? 'reveal.js/css/print/pdf.css' : 'reveal.js/css/print/paper.css';
        document.getElementsByTagName('head')[0].appendChild(link);
    </script>
</head>
<body>
<div class="reveal">
    <div class="slides">
        <section>
            <h3>The Bits Between the Bits</h3>
            <h4>How we get to <code>main()</code></h4>
            <h6>Matt Godbolt<br><a href="https://twitter.com/mattgodbolt">@mattgodbolt</a></h6>
            <h6>CppCon 2018</h6>
        </section>
        <section>
            <!-- GCC 8.1 -->
            <section>
                <h3>A program</h3>
                <pre><code class="cpp" data-trim>
                int main() {}
                </code></pre>
                <pre class="fragment"><code class="bash" data-trim data-noescape>
                    $ gcc -Os empty.c -o c/empty
                    $ g++ -Os empty.cpp -o cpp/empty
                    <div class="fragment">
                    $ ls -l c/empty cpp/empty
                    </div><div class="fragment">7976 c/empty
                    </div><div class="fragment">7976 cpp/empty</div>
                </code></pre>
            </section>
            <section>
                <h3>What's in it?</h3>
                <pre class="fragment"><code class="bash" data-trim data-noescape>
                    $ objdump --no-show-raw-insn -dC cpp/empty</code></pre>
                <pre class="fragment"><code class="x86asm" data-snippet="empty-objdump"></code></pre>
            </section>
            <section>
                <h3>What's in it?</h3>
                <pre class="fragment"><code class="bash" data-trim>
                    $ readelf -a cpp/empty</code></pre>
                <pre class="fragment"><code data-trim>ELF Header:
  Magic:   7f 45 4c 46 02 01 01 00 00 00 00 00 00 00 00 00
  Class:                             ELF64
...
Section Headers:
  [Nr] Name              Type             Address           Offset
  [ 0]                   NULL             0000000000000000  00000000
  [ 1] .interp           PROGBITS         0000000000400238  00000238
...
Relocation section '.rela.dyn' at offset 0x380 contains 2 entries:
  Offset Type              Sym. Value   Sym. Name + Addend
0600ff0  R_X86_64_GLOB_DAT 00000000     __libc_start_main@GLIBC_2.2.5 + 0
0600ff8  R_X86_64_GLOB_DAT 00000000     __gmon_start__ + 0
...
Symbol table '.symtab' contains 58 entries:
   Num:    Value          Size Type    Bind   Vis      Ndx Name
...
    24: 0000000000000000     0 FILE    LOCAL  DEFAULT  ABS empty.cpp
    25: 0000000000000000     0 FILE    LOCAL  DEFAULT  ABS crtstuff.c
...
                </code></pre>
            </section>
            <section>
                <h3>The ELF file format</h3>
                <img src="images/Elf-layout--en.svg" height="400px">
                <div class="attribution">
                    By Surue√±a [<a href="https://creativecommons.org/licenses/by-sa/3.0">CC BY-SA 3.0</a>], <a
                        href="https://commons.wikimedia.org/wiki/File:Elf-layout--en.svg">from Wikimedia Commons</a>
                </div>
            </section>
            <section>
                <h3>Sections</h3>
                <ul>
                    <li><code>.text</code> &mdash; code</li>
                    <li><code>.rodata</code> &mdash; read-only data</li>
                    <li><code>.data</code>&mdash; read/write data</li>
                    <li><code>.bss</code> &mdash; uninitialised data</li>
                </ul>
            </section>
            <section>
                <h3>Sections</h3>
                <pre class="fragment"><code class="bash" data-trim data-noescape>
                    $ readelf --sections cpp/empty</code></pre>
                <pre class="fragment"><code class="x86asm" data-snippet="empty-readelf-sections"></code></pre>
            </section>
        </section>
        <section>
            <section>
                <h3>How we get to <code>main()</code></h3>
                A slightly more interesting program
                <pre><code data-trim>#include &lt;iostream>

int i;
struct Global {
  Global() { i++; }
};

Global global;

int main() {
  std::cout &lt;&lt; "i = " &lt;&lt; i &lt;&lt; "\n";
}
</code></pre>
                <div class="fragment">What does it print?</div>
            </section>
            <section>
                <h3>What does it print?</h3>
                <pre><code data-trim data-noescape>
$ g++ -Os global.cpp -o global
$ ./global
<div class="fragment">i = 1</div>
                </code></pre>
            </section>
            <section>
                <h3>Code Archaeology - Part 1</h3>
                <aside class="notes">
                <pre><code>
$ gdb research/out/global/c++/none/dynamic/global
...
(gdb) print i
$1 = 0
(gdb) break main
(gdb) run # stops on breakpoint
(gdb) disas
(gdb) p i
$2 = 1
####
                </code></pre>
                </aside>
            </section>
            <section>
                <h3>Call stack</h3>
                <pre><code data-trim data-noescape>
<div class="fragment highlight-current-code">#0  Global::Global (this=0x601050 &lt;global>) at global.cpp:6
</div><div class="fragment highlight-current-code">#1  0x000000000040079d in __static_initialization_and_destruction_0 (
    __initialize_p=1, __priority=65535) at global.cpp:10
#2  0x00000000004007b3 in _GLOBAL__sub_I_global.cpp(void) () at global.cpp:14
</div><div class="fragment highlight-current-code">#3  0x000000000040082d in __libc_csu_init ()
#4  0x00007ffff70c1b28 in __libc_start_main (main=0x400702 &lt;main()>, argc=1,
    ... at ../csu/libc-start.c:266
</div>#5  0x000000000040064a in _start ()
                </code></pre>
            </section>
            <section>
                <h3>Where do these functions come from?</h3>
                <a class="fragment" target="_blank" href="https://godbolt.org/z/X979VP">https://godbolt.org/z/X979VP</a>
            </section>
            <section>
                <h3>Who calls this function?</h3>
            </section>
            <section>
                <pre><code data-trim data-noescape>
// Paraphrased from glibc/csu/elf-init.c
<div class="fragment highlight-current-code">typedef void (*init_func)(int, char **, char **);
</div>
<div class="fragment highlight-current-code">extern init_func __init_array_start[];
extern init_func __init_array_end[];
</div>
int __libc_csu_init(int argc, char **argv, char **envp) {
<div class="fragment highlight-current-code">  const size_t size = __init_array_end - __init_array_start;
</div><div class="fragment highlight-current-code">  for (size_t i = 0; i < size; i++)
    (*__init_array_start[i])(argc, argv, envp);
</div>}
                </code></pre>
                <a class="fragment" target="_blank" href="https://godbolt.org/z/PRQ_-Z">https://godbolt.org/z/PRQ_-Z</a>
            </section>
            <section>
                <h3>Ok but...</h3>
                Where do <code>__init_array_start</code> and <code>__init_array_end</code> come from?
            </section>
            <section>
                <h3>Witchcraft!</h3>
                <pre><code data-trim>
.section .init_array,"aw"
.align   8
.quad    _GLOBAL__sub_I_i
.text
                </code></pre>
            </section>
        </section>
        <section>
            <section>
                <h3>The Linker</h3>
                <p>What does it do?</p>
                <ul>
                    <li>Resolves references between TUs</li>
                    <li>Writes metadata (e.g. ELF headers)</li>
                    <li>Determines the layout of an executable</li>
                    <li>Collects data into sections (TODO)</li>
                </ul>
            </section>
        </section>

        <section>
            g++ -o /dev/null -x c /dev/null -Wl,--verbose
        </section>

        <!--- this here as the segment from the Global example where the magic happens -->
        <section>
        </section>
        <section>
    <pre><code data-trim>
  .init_array     :
  {
    PROVIDE_HIDDEN (__init_array_start = .);
    KEEP (*(SORT_BY_INIT_PRIORITY(.init_array.*) SORT_BY_INIT_PRIORITY(.ctors.*)))
    KEEP (*(.init_array EXCLUDE_FILE (
            *crtbegin.o *crtbegin?.o *crtend.o *crtend?.o ) .ctors))
    PROVIDE_HIDDEN (__init_array_end = .);
  }
    </code></pre>
        </section>

        <section>
            Edit code / MAKE / run!
            But what witchcraft happens between compiler and that?
            Knowing why will help you understand... ODR violations, link times etc
        </section>
        <section>
            Overview
            linux only
        </section>
        <section>
            Example C program, static and non-static (MAYBE ONLY NON-STATIC?)
            <ul>
                <li>Why is it so large?</li>
                <li>What's in it?</li>
            </ul>
        </section>
        <section>
            <p>C world!
                .o files, tools to look at them
                [maybe turn off debug symbols for this bit?]</p>
            <ul>
                <li>nm (show T main and U puts)</li>
                <li>objdump -d (show disassembly with call 0x00000)</li>
                <li>Show that even symbols in the same file aren't resolved (tricky)</li>
                <li>objdump -r (show reloc)</li>
                <li>objdump -dr (show together)</li>
                <li>readelf? (needed later but for now maybe no?)</li>
            </ul>
            <p>
                sections, relocations (TODO uses for it, hot/cold code and other magic)
                WEAK references (setup for ODR stuff?) - maybe introduce later with C++
            </p>
        </section>
        <section>
            Quick mention of .a files?
        </section>
        <section>
            The linker! (ld, gold)
            High level view of what it does
            * gather sections together, resolve relocations (CHECK is it relocations?)
        </section>
        <section>
            Finding libraries used (-v)
            - dissect command line, look at -dumpspecs (doesn't have everything we'd need to look at)
            start group, end group (library ordering matters)
        </section>
        <section>
            So far C, what about C++?
            simple template usage, show weak refs? (setup for ODR viol?)
        </section>
        <section>
            global constructors, destructors
            - callgrind to main? wth is going on? poll on how many instructions for an empty executable
        </section>
        <section>
            But what about dynamic linkage?
            ld.so, interpreter
            ELF file layout slide?
        </section>
        <section>
            A new challenger enters: LTO!
            - betterer, ODR violation finder
        </section>
        <section>
            Practical advice
            - `LD_DEBUG` and `LD_PRELOAD`
            - LTO usage?
            -
        </section>
        <section>
            - linker sections (-ffunction-sections, -fdata-sections, --gc-sections?)
            -
        </section>
        <section>
            <section>Bonus slides</section>
            <section>
                War stories
                - exceptions thrown across SO bounadaries
                - (global construction order issues?)
            </section>
            <section>
                Advanced section-fu (putting sideband data in a section?)
            </section>
            <section>
                Linker sctipts?
            </section>
        </section>
    </div>
</div>

<script src="reveal.js/lib/js/head.min.js"></script>
<script src="reveal.js/js/reveal.js"></script>


<script>
    Reveal.initialize({
        history: true,
        transition: 'fade',
        slideNumber: true,
        width: 1280,
        height: 720,
        dependencies: [
            {src: 'reveal.js/plugin/markdown/marked.js'},
            {src: 'reveal.js/plugin/markdown/markdown.js'},
            {src: 'reveal.js/plugin/notes/notes.js', async: true},
            {src: 'snippets.js'},
            {
                src: 'reveal.js/plugin/highlight/highlight.js',
                async: true,
                callback: () => hljs.initHighlightingOnLoad()
            }
        ]
    });
</script>
</body>
</html>
